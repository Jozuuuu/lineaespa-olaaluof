<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hoja de Corte – Línea Española</title>

<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    if(!localStorage.getItem('activo')){
        window.location.href = 'index.html';
    }
</script>
<style>
  /* Dashboard Theme Overrides */
  body {
      background-color: var(--bg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  .dashboard-container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      animation: fadeIn 0.5s ease-out;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 24px 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 20px;
  }
  
  .header-branding { display: flex; align-items: center; gap: 20px; }
  .header-logo { height: 48px; width: auto; }
  
  .header-left h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 800; }
  .header-left p { margin: 4px 0 0; color: var(--text-light); }

  .calc-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      align-items: start;
  }

  .card-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
  }

  /* Form Elements */
  .control-group { margin-bottom: 20px; }
  .control-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 0.95rem; }
  .control-group input, .control-group select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      font-size: 1rem;
      transition: var(--transition);
      color: var(--text);
  }
  .control-group input:focus, .control-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      background: white;
  }

  /* Measures grid specific */
  .measures-container {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 10px;
  }
  .measures-container .control-group {
      flex: 1 1 150px; /* Grow, shrink, base 150px */
      margin-bottom: 0; /* Handled by container gap/wrap if needed, but flex gap handles horizontal */
  }

  /* Results Table */
  .table-responsive { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
  th { text-align: left; padding: 12px; background: var(--bg); color: var(--text-light); border-bottom: 2px solid var(--border); font-weight: 600; }
  td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: var(--text); }
  td img.perfil-img { height: 40px; display: block; }
  
  .hoja-preview-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius);
      text-align: center;
  }
  .hoja-preview-img { max-height: 120px; width: auto; mix-blend-mode: multiply; }

  /* Buttons */
  .btn { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; border: none; padding: 10px 20px; border-radius: var(--radius); transition: all 0.2s; text-decoration: none; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
  .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { background: var(--bg); border-color: var(--text-light); }
  .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
  .btn-danger:hover { background: #fee2e2; border-color: #ef4444; }

  /* Saved Items */
  .saved-item {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: var(--shadow-sm);
  }
  .saved-item h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; color: var(--primary); font-size: 1.1rem; }
  
  .hidden { display: none !important; }
  .w-full { width: 100%; }
  .mt-4 { margin-top: 1rem; }

  @media (max-width: 900px) {
      .calc-grid { grid-template-columns: 1fr; }
  }

  /* Estilos para Impresión / PDF */
  @media print {
      body { background: white; display: block; padding: 0; }
      .dashboard-container { max-width: 100%; padding: 0; margin: 0; }
      .dashboard-header, .calc-grid, .btn { display: none !important; }
      #zonaAcumulados { display: block !important; margin: 0 !important; box-shadow: none !important; border: none !important; padding: 0 !important; }
      .saved-item { border: none !important; border-bottom: 1px solid #000 !important; box-shadow: none !important; page-break-inside: avoid; }
      .saved-item button { display: none !important; }
      h2 { color: black !important; }
  }
</style>
</head>
<body>

<div class="dashboard-container">
  
  <div class="dashboard-header">
    <div class="header-branding">
        <img src="https://aluoferta.com/wp-content/uploads/2021/03/logo-aluoferta.png" alt="Aluoferta" class="header-logo" onerror="this.src='img/aluoferta_logo.png'">
        <div class="header-left">
            <h1>Calculadora de Cortes</h1>
            <p>Optimización y cálculo de material — Línea Española</p>
        </div>
    </div>
    <a href="menu.html" class="btn btn-outline">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Volver al Menú
    </a>
  </div>

  <div class="calc-grid">
    <!-- Panel Izquierdo: Configuración -->
    <div class="card-panel">
      <h2 style="margin-top:0; color:var(--primary); font-size:1.2rem; margin-bottom:20px;">Configuración</h2>

      <div class="control-group">
        <label>Línea de Perfil</label>
        <select id="linea" onchange="configurarLinea()">
            <option value="">-- Selecciona --</option>
            <option value="1400">1400 (Abatible)</option>
            <option value="3500">3500 (Corrediza)</option>
            <option value="4600">4600 (Perímetros y Monumental)</option>
        </select>
      </div>

      <div class="control-group">
        <label>Tipo / Configuración</label>
        <select id="tipo"></select>
      </div>

      <div class="measures-container">
          <div class="control-group">
            <label>Ancho (mm)</label>
            <input type="number" id="B" placeholder="Ej. 1800">
          </div>

          <div class="control-group">
            <label>Alto (mm)</label>
            <input type="number" id="A" placeholder="Ej. 2100">
          </div>
      </div>

      <button class="btn btn-primary w-full mt-4" onclick="calcular()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Calcular Material
      </button>
    </div>

    <!-- Panel Derecho: Resultados -->
    <div class="card-panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2 style="margin:0; color:var(--primary); font-size:1.2rem;">Resultados</h2>
          <div id="actionButtons" class="hidden">
              <button class="btn btn-outline" style="border-color:var(--accent); color:var(--accent);" onclick="agregarAComulados()">
                + Agregar a Lista
              </button>
          </div>
      </div>
      
      <div id="resultado" style="min-height:200px; display:flex; flex-direction:column; justify-content:center;">
          <div style="text-align:center; color:var(--text-light);">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5" style="margin-bottom:10px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
              <p>Selecciona una línea y dimensiones para ver el despiece.</p>
          </div>
      </div>
    </div>
  </div>

  <!-- Sección de Acumulados -->
  <div id="zonaAcumulados" class="card-panel hidden" style="margin-top: 24px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--border);">
        <h2 style="margin:0; color:var(--primary);">Hoja de Pedido / Resumen</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="limpiarTodo()">Limpiar Todo</button>
            <button class="btn btn-primary" onclick="exportarPDF()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Descargar PDF
            </button>
        </div>
      </div>
      <div id="listaItems"></div>
  </div>

</div>

<script>
let ultimoCalculo = null;
let listaCortes = [];

function configurarLinea(){
let linea=document.getElementById("linea").value;
let tipo=document.getElementById("tipo");
tipo.innerHTML='<option value="">-- Selecciona --</option>';

if(linea==="1400"){
tipo.innerHTML+=`
<option value="1400_proj_ventana">Proyección 1 hoja – Ventana</option>
<option value="1400_proj_puerta">Proyección 1 hoja – Puerta</option>
<option value="1400_ventana_2h">Ventana 2 hojas apertura interior</option>
<option value="1400_puerta_1h">Puerta 1 hoja</option>
<option value="1400_puerta_2h">Puerta 2 hojas</option>`;
}

if(linea==="3500"){
tipo.innerHTML+=`
<option value="3500_2h">Corrediza 2 hojas</option>
<option value="3500_3h">Corrediza 3 hojas</option>
<option value="3500_4h">Corrediza 4 hojas</option>`;
}

if(linea==="4600"){
tipo.innerHTML+=`
<option value="4600_r2">Recta – 2 hojas</option>
<option value="4600_r3">Recta – 3 hojas</option>
<option value="4600_r4">Recta – 4 hojas</option>
<option value="4600_r6">Recta – 6 hojas</option>
<option value="4600_m2">Monumental – 2 hojas</option>
<option value="4600_m3">Monumental – 3 hojas</option>
<option value="4600_m4">Monumental – 4 hojas</option>
<option value="4600_m6">Monumental – 6 hojas</option>`;
}
}

function fila(n,c,m,co){
  const img=getImageForPerfil(n);
  // Limitar decimales a máximo 2
  let medida = m;
  if(typeof m === 'number'){
      medida = parseFloat(m.toFixed(2));
  }
  return `<tr>
    <td>${n}</td>
    <td><img class="perfil-img" src="${img}" alt="${n}"></td>
    <td>${c}</td>
    <td>${medida} mm</td>
    <td>${co}</td>
  </tr>`;
}

/* NUEVO: guarda la configuración seleccionada para decidir imágenes por línea */
let currentTipoSeleccionado = "";

/* Reemplazamos la función getImageForPerfil para devolver imágenes por línea (1400/3500/4600),
   y diferenciar puerta / ventana / monumental / corrediza / perimetral. */
function getImageForPerfil(perfil){
  const p = perfil.toLowerCase();
  // determina línea desde la selección actual
  let lineKey = "common";
  if(currentTipoSeleccionado && currentTipoSeleccionado.startsWith("1400")) lineKey = "1400";
  else if(currentTipoSeleccionado && currentTipoSeleccionado.startsWith("3500")) lineKey = "3500";
  else if(currentTipoSeleccionado && currentTipoSeleccionado.startsWith("4600")) lineKey = "4600";

  // prioridad: entradas específicas
  if(p.includes("junquillo")) return `img/perfiles/${lineKey}/junquillo.png`;
  if(p.includes("zócalo") || p.includes("zocalo")) return `img/perfiles/${lineKey}/zocalo.png`;
  if(p.includes("pilastra")) return `img/perfiles/${lineKey}/pilastra.png`;
  if(p.includes("ruedas")) return `img/perfiles/${lineKey}/hoja_ruedas.png`;
  if(p.includes("unión") || p.includes("union cuatro hojas")) return `img/perfiles/${lineKey}/union_cuatro.png`;

  // --- 3500: distinguir cerco superior / inferior / lateral y marco H/V ---
  if(lineKey === "3500"){
    if(p.includes("cerco inferior")) return `img/perfiles/3500/cerco_inferior.png`;
    if(p.includes("cerco superior")) return `img/perfiles/3500/cerco_superior.png`;
    if(p.includes("cerco lateral")) return `img/perfiles/3500/cerco_lateral.png`;
    if(p.includes("marco") || p.includes("cerco")){
      if(p.includes("horizontal")) return `img/perfiles/3500/marco_horizontal.png`;
      if(p.includes("vertical")) return `img/perfiles/3500/marco_vertical.png`;
      return `img/perfiles/3500/cerco.png`;
    }
    if(p.includes("hoja central")) return `img/perfiles/3500/hoja_central.png`;
    if(p.includes("hoja lateral")) return `img/perfiles/3500/hoja_lateral.png`;
  }

  // --- 4600: separar HOJA PERIMETRAL (normal) de HOJA MONUMENTAL ---
  if(lineKey==="4600"){
    // TAPA monumental primero (si aplica)
    if(p.includes("tapa") && p.includes("monumental")) {
      return `img/perfiles/4600/monumental/tapa_central_monumental.png`;
    }

    // hoja perimetral (aplica a tipos "Hoja perimetral ...")
    if(p.includes("hoja perimetral") || (p.includes("hoja") && p.includes("perimetral"))){
      return `img/perfiles/4600/hoja_perimetral.png`;
    }
    // hoja monumental (aplica a tipos que contienen "monumental" o "hoja monumental")
    if(p.includes("hoja monumental") || p.includes("monumental")){
      return `img/perfiles/4600/monumental/hoja_monumental.png`;
    }

    // rieles / vías y marco perimetral por número de vías (2/3)
    const is2vias = /\b2\s*v[ií]as?\b/.test(p);
    const is3vias = /\b3\s*v[ií]as?\b/.test(p);
    if(p.includes("marco") || p.includes("perimetral")){
      if(is2vias) return `img/perfiles/4600/marco_perimetral_2.png`;
      if(is3vias) return `img/perfiles/4600/marco_perimetral_3.png`;
      return `img/perfiles/4600/marco_perimetral.png`;
    }

    // tapa normal
    if(p.includes("tapa")) return `img/perfiles/4600/tapa_central.png`;
    if(p.includes("hoja perimetral")) return `img/perfiles/4600/hoja_perimetral.png`;
    if(p.includes("hoja")) return `img/perfiles/4600/hoja_perimetral.png`; // default para 'hoja' en 4600
  }

  // ventana vs puerta (por línea)
  if(p.includes("ventana")) {
    return `img/perfiles/${lineKey}/ventana/` + (p.includes("marco") ? "marco_ventana.png" : "hoja_ventana.png");
  }
  if(p.includes("puerta")) {
    return `img/perfiles/${lineKey}/puerta/` + (p.includes("marco") ? "marco_puerta.png" : "hoja_puerta.png");
  }

  // genéricos / fallback por nombre (respetar superior/inferior/lateral si se menciona)
  if(p.includes("cerco inferior")) return `img/perfiles/${lineKey}/cerco_inferior.png`;
  if(p.includes("cerco superior")) return `img/perfiles/${lineKey}/cerco_superior.png`;
  if(p.includes("cerco lateral")) return `img/perfiles/${lineKey}/cerco_lateral.png`;
  if(p.includes("hoja central")) return `img/perfiles/${lineKey}/hoja_central.png`;
  if(p.includes("hoja lateral")) return `img/perfiles/${lineKey}/hoja_lateral.png`;
  if(p.includes("tapa")) return `img/perfiles/${lineKey}/tapa_central.png`;
  if(p.includes("marco")) {
    if(p.includes("horizontal")) return `img/perfiles/${lineKey}/marco_horizontal.png`;
    if(p.includes("vertical")) return `img/perfiles/${lineKey}/marco_vertical.png`;
    return `img/perfiles/${lineKey}/marco_vertical.png`;
  }

  // último recurso
  return `img/perfiles/${lineKey}/default.png`;
}

/* Mapa de imágenes por combinación (tipo) */
const hojaMap = {
  "1400_proj_ventana": {img:"img/perfiles/hoja_1400_proj_ventana.png", title:"Hoja — 1400 Proyección ventana"},
  "1400_proj_puerta":  {img:"img/perfiles/hoja_1400_proj_puerta.png",  title:"Hoja — 1400 Proyección puerta"},
  "1400_ventana_2h":   {img:"img/perfiles/hoja_1400_ventana_2h.png",   title:"Hoja — 1400 Ventana 2 hojas"},
  "1400_puerta_1h":    {img:"img/perfiles/hoja_1400_puerta_1h.png",    title:"Hoja — 1400 Puerta 1 hoja"},
  "1400_puerta_2h":    {img:"img/perfiles/hoja_1400_puerta_2h.png",    title:"Hoja — 1400 Puerta 2 hojas"},

  "3500_2h": {img:"img/perfiles/hoja_3500_2h.png", title:"Hoja — 3500 Corrediza 2 hojas"},
  "3500_3h": {img:"img/perfiles/hoja_3500_3h.png", title:"Hoja — 3500 Corrediza 3 hojas"},
  "3500_4h": {img:"img/perfiles/hoja_3500_4h.png", title:"Hoja — 3500 Corrediza 4 hojas"},

  "4600_r2": {img:"img/perfiles/hoja_4600_r2.png", title:"Hoja — 4600 Recta 2 hojas"},
  "4600_r3": {img:"img/perfiles/hoja_4600_r3.png", title:"Hoja — 4600 Recta 3 hojas"},
  "4600_r4": {img:"img/perfiles/hoja_4600_r4.png", title:"Hoja — 4600 Recta 4 hojas"},
  "4600_r6": {img:"img/perfiles/hoja_4600_r6.png", title:"Hoja — 4600 Recta 6 hojas"},
  "4600_m2": {img:"img/perfiles/hoja_4600_m2.png", title:"Hoja — 4600 Monumental 2 hojas"},
  "4600_m3": {img:"img/perfiles/hoja_4600_m3.png", title:"Hoja — 4600 Monumental 3 hojas"},
  "4600_m4": {img:"img/perfiles/hoja_4600_m4.png", title:"Hoja — 4600 Monumental 4 hojas"},
  "4600_m6": {img:"img/perfiles/hoja_4600_m6.png", title:"Hoja — 4600 Monumental 6 hojas"}
};

function getHojaImage(tipo){
  return (hojaMap[tipo] && hojaMap[tipo].img) ? hojaMap[tipo].img : "img/perfiles/default_hoja.png";
}
function getHojaTitle(tipo){
  return (hojaMap[tipo] && hojaMap[tipo].title) ? hojaMap[tipo].title : "Hoja";
}

/* Reemplaza la función calcular para asignar currentTipoSeleccionado antes de crear filas */
function calcular(){
let tipo=document.getElementById("tipo").value;
let A=parseFloat(document.getElementById("A").value);
let B=parseFloat(document.getElementById("B").value);

if(!tipo||isNaN(A)||isNaN(B)){
document.getElementById("resultado").innerHTML=
'<div style="text-align:center; padding:30px; color:#ef4444; background:#fef2f2; border-radius:8px;">⚠️ Por favor completa la selección de línea y medidas</div>';
return;
}

/* NUEVO: set global para que getImageForPerfil use la línea/configuración actual */
currentTipoSeleccionado = tipo;

/* preview de la hoja seleccionada */
const hojaImg = getHojaImage(tipo);
const hojaTitle = getHojaTitle(tipo);
const preview = `<div class="hoja-preview-wrap">
  <img class="hoja-preview-img" src="${hojaImg}" alt="${hojaTitle}">
  <div style="font-weight:600; font-size:0.9rem; color:var(--text);">${hojaTitle}</div>
</div>`;

let h=`<div class="table-responsive"><table>
<tr><th>Perfil</th><th>Img</th><th>Cant.</th><th>Medida</th><th>Corte</th></tr>`;
/* =======================
   LÍNEA 1400
======================= */
/* (SIN CAMBIOS) */

if(tipo==="1400_proj_ventana"){
h+=fila("Marco liso ventana vertical",2,A,"45° / 45°");
h+=fila("Marco liso ventana horizontal",2,B,"45° / 45°");
h+=fila("Hoja lisa ventana vertical",2,A-42,"45° / 45°");
h+=fila("Hoja lisa ventana horizontal",2,B-42,"45° / 45°");
// Junquillo (debe medirse)
h+=`<tr>
  <td>Junquillo</td>
  <td><img class="perfil-img" src="${getImageForPerfil('Junquillo')}" alt="Junquillo"></td>
  <td>4</td>
  <td><strong>Obra</strong></td>
  <td>—</td>
</tr>`;
}

if(tipo==="1400_proj_puerta"){
h+=fila("Marco liso puerta vertical",2,A,"45° / 45°");
h+=fila("Marco liso puerta horizontal",2,B,"45° / 45°");
h+=fila("Hoja lisa puerta vertical",2,A-73,"45° / 45°");
h+=fila("Hoja lisa puerta horizontal",2,B-73,"45° / 45°");
// Junquillo (debe medirse)
h+=`<tr>
  <td>Junquillo</td>
  <td><img class="perfil-img" src="${getImageForPerfil('Junquillo')}" alt="Junquillo"></td>
  <td>4</td>
  <td><strong>Obra</strong></td>
  <td>—</td>
</tr>`;
}

if(tipo==="1400_ventana_2h"){
h+=fila("Marco liso ventana vertical",2,A,"45° / 45°");
h+=fila("Marco liso ventana horizontal",2,B,"45° / 45°");
h+=fila("Hoja lisa ventana vertical",4,A-42,"45° / 45°");
h+=fila("Hoja lisa ventana horizontal",4,(B-56)/2,"45° / 45°");
h+=fila("Pilastra lisa ventana (T)",1,A-93,"Recto");
// Junquillo (debe medirse)
h+=`<tr>
  <td>Junquillo</td>
  <td><img class="perfil-img" src="${getImageForPerfil('Junquillo')}" alt="Junquillo"></td>
  <td>4</td>
  <td><strong>Obra</strong></td>
  <td>—</td>
</tr>`;
}

if(tipo==="1400_puerta_1h"){
h+=fila("Marco liso puerta vertical",2,A,"90° / 45°");
h+=fila("Marco liso puerta horizontal",1,B,"45°");
h+=fila("Hoja lisa puerta vertical",2,A-43,"45° / 90°");
h+=fila("Hoja lisa puerta horizontal",1,B-73,"45°");
h+=fila("Zócalo inferior",1,B-177,"90°");
// Junquillo (debe medirse)
h+=`<tr>
  <td>Junquillo</td>
  <td><img class="perfil-img" src="${getImageForPerfil('Junquillo')}" alt="Junquillo"></td>
  <td>4</td>
  <td><strong>Obra</strong></td>
  <td>—</td>
</tr>`;
}

if(tipo==="1400_puerta_2h"){
h+=fila("Marco liso puerta vertical",2,A,"90° / 45°");
h+=fila("Marco liso puerta horizontal",1,B,"45°");
h+=fila("Hoja lisa puerta vertical",4,A-43,"45° / 90°");
h+=fila("Hoja lisa puerta horizontal",2,(B-90)/2,"45°");
h+=fila("Pilastra lisa ventana",1,A-65,"Recto");
h+=fila("Zócalo inferior",2,(B-300)/2,"90°");
// Junquillo (debe medirse) — ya existente, mantenido consistente
h+=`<tr>
  <td>Junquillo</td>
  <td><img class="perfil-img" src="${getImageForPerfil('Junquillo')}" alt="Junquillo"></td>
  <td>4</td>
  <td><strong>Obra</strong></td>
  <td>—</td>
</tr>`;
}

/* =======================
   LÍNEA 3500
======================= */
/* (SIN CAMBIOS) */

if(tipo==="3500_2h"){
h+=fila("Cerco inferior",1,B-41,"90°");
h+=fila("Cerco superior",1,B-41,"90°");
h+=fila("Cerco lateral",2,A,"90°");
h+=fila("Hoja central (traslape)",2,A-53,"90°");
h+=fila("Hoja lateral",2,A-53,"90°");
h+=fila("Hoja de ruedas",4,(B-33)/2,"90°");
}

if(tipo==="3500_3h"){
h+=fila("Cerco inferior",1,B-41,"90°");
h+=fila("Cerco superior",1,B-41,"90°");
h+=fila("Cerco lateral",2,A,"90°");
h+=fila("Hoja central (traslape)",4,A-53,"90°");
h+=fila("Hoja lateral",2,A-53,"90°");
h+=fila("Hoja de ruedas",6,(B+12)/3,"90°");
}

if(tipo==="3500_4h"){
h+=fila("Cerco inferior",1,B-41,"90°");
h+=fila("Cerco superior",1,B-41,"90°");
h+=fila("Cerco lateral",2,A,"90°");
h+=fila("Hoja central (traslape)",4,A-53,"90°");
h+=fila("Hoja lateral",4,A-53,"90°");
h+=fila("Hoja de ruedas",8,(B-19)/4,"90°");
h+=fila("Unión cuatro hojas",1,A-73,"90°");
}

/* =======================
   LÍNEA 4600
======================= */

if(tipo==="4600_r2"){
h+=fila("Marco perimetral 2 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 2 vías horizontal",2,B,"45°");
h+=fila("Hoja perimetral vertical",4,A-70,"45°");
h+=fila("Hoja perimetral horizontal",4,(B-9)/2,"45°");
h+=fila("Tapa hoja central",2,A-73,"90°");
}

if(tipo==="4600_r3"){
h+=fila("Marco perimetral 3 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 3 vías horizontal",2,B,"45°");
h+=fila("Hoja perimetral vertical",6,A-70,"45°");
h+=fila("Hoja perimetral horizontal",6,(B+52)/3,"45°");
h+=fila("Tapa hoja central",4,A-73,"90°");
}

if(tipo==="4600_r4"){
h+=fila("Marco perimetral 2 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 2 vías horizontal",2,B,"45°");
h+=fila("Hoja perimetral vertical",8,A-70,"45°");
h+=fila("Hoja perimetral horizontal",8,(B+51)/4,"45°");
h+=fila("Tapa hoja central",4,A-73,"90°");
h+=fila("Unión cuatro hojas",1,A-90,"90°");
}

if(tipo==="4600_r6"){
h+=fila("Marco perimetral 3 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 3 vías horizontal",2,B,"45°");
h+=fila("Hoja perimetral vertical",12,A-70,"45°");
h+=fila("Hoja perimetral horizontal",12,(B+178)/6,"45°");
h+=fila("Tapa hoja central",8,A-73,"90°");
h+=fila("Unión cuatro hojas",1,A-90,"90°");
}

if(tipo==="4600_m2"){
h+=fila("Marco perimetral 2 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 2 vías horizontal",2,B,"45°");
h+=fila("Hoja monumental vertical",4,A-70,"45°");
h+=fila("Hoja monumental horizontal",4,B/2,"45°");
h+=fila("Tapa hoja central monumental",2,A-73,"90°");
}

if(tipo==="4600_m3"){
h+=fila("Marco perimetral 3 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 3 vías horizontal",2,B,"45°");
h+=fila("Hoja monumental vertical",6,A-70,"45°");
h+=fila("Hoja monumental horizontal",6,(B+71)/3,"45°");
h+=fila("Tapa hoja central monumental",4,A-73,"90°");
}

if(tipo==="4600_m4"){
h+=fila("Marco perimetral 2 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 2 vías horizontal",2,B,"45°");
h+=fila("Hoja monumental vertical",8,A-70,"45°");
h+=fila("Hoja monumental horizontal",8,(B+66)/4,"45°");
h+=fila("Tapa hoja central monumental",4,A-73,"90°");
h+=fila("Unión cuatro hojas",1,A-90,"90°");
}

if(tipo==="4600_m6"){
h+=fila("Marco perimetral 3 vías vertical",2,A,"45°");
h+=fila("Marco perimetral 3 vías horizontal",2,B,"45°");
h+=fila("Hoja monumental vertical",12,A-70,"45°");
h+=fila("Hoja monumental horizontal",12,(B+205)/6,"45°");
h+=fila("Tapa hoja central monumental",8,A-73,"90°");
h+=fila("Unión cuatro hojas",1,A-90,"90°");
}

h+="</table></div>";
document.getElementById("resultado").innerHTML = preview + h;
document.getElementById("actionButtons").classList.remove("hidden");

// Guardar datos temporalmente para poder agregar
ultimoCalculo = {
    titulo: `Línea ${document.getElementById("linea").value} - ${getHojaTitle(tipo)}`,
    medidas: `Ancho: ${B}mm x Alto: ${A}mm`,
    html: h,
    preview: preview
};
}

function agregarAComulados(){
    if(!ultimoCalculo) return;
    
    listaCortes.push({...ultimoCalculo, id: Date.now()});
    renderLista();
    
    // Scroll al área de acumulados
    document.getElementById("zonaAcumulados").classList.remove("hidden");
    document.getElementById("listaItems").scrollIntoView({behavior: 'smooth'});
}

function renderLista(){
    const contenedor = document.getElementById("listaItems");
    const zona = document.getElementById("zonaAcumulados");
    
    if(listaCortes.length === 0){
        zona.classList.add("hidden");
        return;
    }
    zona.classList.remove("hidden");
    
    contenedor.innerHTML = listaCortes.map((item, index) => `
        <div class="saved-item" id="item-${item.id}">
            <h3>
                <span>
                    <strong>#${index + 1}</strong> ${item.titulo} 
                    <small style="color:#64748b; margin-left:10px;">(${item.medidas})</small>
                </span>
                <button class="btn btn-danger" style="font-size:0.8rem; padding:4px 10px;" onclick="eliminarItem(${item.id})">Eliminar</button>
            </h3>
            <div style="display:grid; grid-template-columns: 200px 1fr; gap:24px; align-items:start; margin-top:10px;">
                <div style="text-align:center;">${item.preview}</div>
                <div>${item.html}</div>
            </div>
        </div>
    `).join('');
}

function eliminarItem(id){
    listaCortes = listaCortes.filter(i => i.id !== id);
    renderLista();
}

function limpiarTodo(){
    if(confirm('¿Borrar toda la lista?')){
        listaCortes = [];
        renderLista();
    }
}

function exportarPDF(){
    const element = document.getElementById('listaItems');
    if(!element || listaCortes.length === 0) return alert("No hay datos para exportar");

    // Intentar usar librería si está disponible
    if(typeof html2pdf !== 'undefined'){
        const opt = {
          margin:       10,
          filename:     `Cortes_Aluminio_${new Date().toISOString().slice(0,10)}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, logging: false },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // .save() devuelve una promesa
        html2pdf().set(opt).from(element).save().catch(err => {
            console.error("Fallo librería PDF, usando nativo:", err);
            window.print();
        });
    } else {
        // Fallback: usar impresión nativa del navegador (Guardar como PDF)
        // Gracias al CSS @media print, solo saldrá la lista
        window.print();
    }
}
</script>

</body>
</html>
