<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Acceso Inventario - Aluoferta</title>
<link rel="stylesheet" href="styles.css">
</head>
<body class="centered">

<div class="container-sm card" id="login">
    <img src="https://aluoferta.com/wp-content/uploads/2021/03/logo-aluoferta.png" alt="Aluoferta Logo" class="logo" onerror="this.src='img/aluoferta_logo.png'">
    <h2 class="text-center">Iniciar Sesión</h2>
    <div class="control-group">
        <input id="loginUser" placeholder="Usuario">
        <input id="loginPass" type="password" placeholder="Contraseña">
    </div>
    
    <button onclick="login()" class="btn btn-primary w-100 mt-4">Entrar</button>
    
    <p id="loginMsg" class="text-center mt-4" style="color: var(--danger);"></p>
    
    <div class="footer">
        ¿No tienes cuenta? <a onclick="toggleView()" style="cursor: pointer;">Regístrate aquí</a>
        <br><br>
        <a href="index.html">Volver al inicio</a>
    </div>
</div>

<div class="container-sm card hidden" id="registro">
    <img src="https://aluoferta.com/wp-content/uploads/2021/03/logo-aluoferta.png" alt="Aluoferta Logo" class="logo" onerror="this.src='img/aluoferta_logo.png'">
    <h2 class="text-center">Solicitar Acceso</h2>
    <div class="control-group">
        <input id="regUser" placeholder="Usuario deseado">
        <input id="regPass" type="password" placeholder="Contraseña">
    </div>
    
    <button onclick="registrar()" class="btn btn-primary w-100 mt-4">Enviar Solicitud</button>
    
    <div class="footer">
        ¿Ya tienes cuenta? <a onclick="toggleView()" style="cursor: pointer;">Inicia sesión</a>
    </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby9RjQ5V1G2m6M2ORE6lZgkPTYPdQLbCqqxBVJL2lYPrPyeXKG34ANueQGRb1nPka7Z0g/exec';

const loginDiv = document.getElementById('login');
const registroDiv = document.getElementById('registro');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginMsg = document.getElementById('loginMsg');
const regUser = document.getElementById('regUser');
const regPass = document.getElementById('regPass');

function hash(txt){ return btoa(unescape(encodeURIComponent(txt))); }

function toggleView(){
    loginDiv.classList.toggle('hidden');
    registroDiv.classList.toggle('hidden');
    loginMsg.innerText = '';
}

async function registrar(){
 let u=regUser.value.trim(),p=regPass.value;
 if(!u||!p) return alert("Por favor complete todos los campos");
 
 try {
    const hashed = hash(p);
    const body = new URLSearchParams({ action: 'register', user: u, pass: hashed }).toString();
    const res = await fetch(GAS_URL, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body 
    });
    const data = await res.json();
    
    if(data.error) {
        alert("Error: " + data.error);
    } else {
        alert("Solicitud enviada. Contacte al administrador para aprobación.");
        toggleView();
    }
 } catch(e) {
    console.error(e);
    alert("Error de conexión");
 }
}

async function login(){
 try{
  const u=loginUser.value.trim(),p=loginPass.value;
  if(!u || !p) { loginMsg.innerText="Complete los campos"; return; }
  
  loginMsg.innerText = "Verificando...";
  
  const hashed = hash(p);
  // Use POST to avoid logging credentials in URL parameters
  const body = new URLSearchParams({ action: 'login', user: u, pass: hashed }).toString();
  
  const res = await fetch(GAS_URL, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body 
  });
  const data = await res.json();
  
  if(data.error){
      loginMsg.innerText = data.error;
  } else if(data.ok){
      localStorage.setItem('activo', data.user);
      localStorage.setItem('rol', data.role);
      window.location.href='inventario.html';
  }
 }catch(err){
  console.error(err);
  loginMsg.innerText='Error de conexión';
 }
}
</script>
</body>
</html>
