<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Inventario - Sistema de Bodega</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f2f2f2;padding:16px}
        .container{background:#fff;padding:16px;border-radius:8px;margin-bottom:12px}
        .header{display:flex;gap:12px;align-items:center}
        .header b{font-size:1.05em}
        .controls{display:flex;gap:8px;align-items:center;margin:12px 0}
        .controls input{flex:1;padding:8px}
        #formArea{border:1px solid #e0e0e0;padding:10px;border-radius:6px;background:#fafafa}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#f7f7f7}
        .actions button{margin-right:6px}
        .hidden{display:none}
        .admin-panel{background:#fff3cd;padding:10px;border-radius:6px}
        @media(min-width:800px){ .controls input{flex:1} }
    </style>
</head>
<body>

    <h1>üì¶ Inventario (simple)</h1>

    <div class="container">
        <div style="display:flex;gap:8px;align-items:center">
            <div>Usuario: <b id="usuarioActivo">-</b></div>
            <button id="btnLogout" style="margin-left:8px">Cerrar sesi√≥n</button>
        </div>

        <hr>

        <div class="controls">
            <label style="white-space:nowrap">Categor√≠a:</label>
            <select id="categoriaSel">
                <option value="todas" selected>Todas</option>
                <option value="vidrio">Vidrio</option>
                <option value="aluminio">Aluminio</option>
                <option value="herrajes">Herrajes</option>
                <option value="insumos">Insumos</option>
            </select>
            <input id="busqueda" placeholder="Buscar...">
            <label style="white-space:nowrap">Filtrar campo:</label>
            <select id="filterField">
                <option value="Todos">Todos</option>
            </select>
            <button id="btnAdvancedSearch">B√∫squeda avanzada</button>
            <button id="btnNew">Agregar producto nuevo</button>
        </div>

        <div id="formArea" class="hidden"></div>
        <div id="tablesArea"></div>

        <!-- Advanced search modal -->
        <div id="searchMenu" class="hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.2);max-width:90%;width:600px;z-index:999">
            <h3>B√∫squeda avanzada</h3>
            <div id="searchSteps"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button id="applySearch">Aplicar</button>
                <button id="cancelSearch">Cancelar</button>
            </div>
        </div>

        <div id="adminPanel" class="container hidden admin-panel">
            <h3>üëë Panel Administrador</h3>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1;min-width:280px">
                    <h4>Usuarios</h4>
                    <table id="tablaUsuariosAdmin"><thead><tr><th>Usuario</th><th>Estado</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
                </div>
                <div style="flex:1;min-width:280px">
                    <h4>Bit√°cora</h4>
                    <button id="exportLogCSV">Exportar bit√°cora (CSV)</button>
                    <table id="tablaLogAdmin"><thead><tr><th>Fecha</th><th>Usuario</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- socket.io script loaded dynamically when available -->
    <script>
    // --- Data load ---
    const usuarioActivoEl = document.getElementById('usuarioActivo');
    const btnLogout = document.getElementById('btnLogout');
    const categoriaSel = document.getElementById('categoriaSel');
    const busqueda = document.getElementById('busqueda');
    const formArea = document.getElementById('formArea');
    const tablesArea = document.getElementById('tablesArea');
    const btnNew = document.getElementById('btnNew');
    const btnAdvancedSearch = document.getElementById('btnAdvancedSearch');
    const searchMenu = document.getElementById('searchMenu');
    const searchSteps = document.getElementById('searchSteps');
    const applySearchBtn = document.getElementById('applySearch');
    const cancelSearchBtn = document.getElementById('cancelSearch');
    const adminPanel = document.getElementById('adminPanel');

    // ensure a sane default category to avoid rendering nothing
    if(categoriaSel && !categoriaSel.value) categoriaSel.value = 'todas';

    let inventory = {vidrio:[],aluminio:[],herrajes:[],insumos:[]};
    // No local server/proxy detection: frontend will post directly to Apps Script
    // migrate legacy 'medida' -> 'medida1'/'medida2' for vidrio items
    if(inventory && inventory.vidrio && Array.isArray(inventory.vidrio)){
        inventory.vidrio.forEach(it=>{
            if(it && !it.medida1 && it.medida){
                const parts = it.medida.split(/x|√ó|,|;/i).map(s=>s.trim()).filter(Boolean);
                it.medida1 = parts[0] || it.medida || '';
                it.medida2 = parts[1] || '';
            }
        });
    }
    // Apps Script Web App exec URL (direct). Replace with your deployment URL if different.
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwXI2drMP3mxNDqwv99ielfqvXc4YF5oSw9tJfoQSoF7AgEONm3JbGfIu67FbGTIfAdPQ/exec';
    // Mapear categor√≠a UI -> id de inventario en Apps Script (ajusta seg√∫n tu configuraci√≥n)
    const CATEGORY_TO_INVENTORY = { aluminio: '1', herrajes: '2', vidrio: '3', insumos: '4' };

    // Templates (campos por categor√≠a)
    const templates = {
        vidrio: ['image','tipo','color','grosor','forma','medida1','medida2','cantidad'],
        aluminio: ['image','linea','serie','nombre','color','codigo','cantidad'],
        herrajes: ['image','nombre','color','codigo','cantidad'],
        insumos: ['image','nombre','tipo','color','codigo','cantidad','acciones']
    };

    // Sync categories from this frontend templates -> Apps Script
    async function syncCategoriesToGAS(){
        try{
            const mapping = {};
            // build inventoryId -> [categories]
            Object.keys(templates).forEach(cat => {
                const inv = CATEGORY_TO_INVENTORY[cat] || null;
                if(!inv) return;
                mapping[inv] = mapping[inv] || [];
                if(!mapping[inv].includes(cat)) mapping[inv].push(cat);
            });
            // send to Apps Script as urlencoded form to avoid CORS preflight
            const body = new URLSearchParams({ syncCategories: '1', categories: JSON.stringify(mapping) }).toString();
            await fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body });
            console.log('Categories synced to Apps Script', mapping);
        }catch(err){ console.warn('Sync categories to GAS failed', err); }
    }

    // --- Fetch inventory from Apps Script ---
    async function loadInventoryForCategory(cat){
        try{
            const invId = CATEGORY_TO_INVENTORY[cat];
            if(!invId) return;
            const url = GAS_URL + '?action=list&inventory=' + encodeURIComponent(invId);
            const res = await fetch(url);
            const txt = await res.text();
            let j = {};
            try{ j = txt ? JSON.parse(txt) : {}; }catch(e){ console.warn('Invalid JSON from GAS list', txt); }
            if(!j || !j.ok || !Array.isArray(j.rows)){
                console.warn('No rows returned for',cat,j);
                inventory[cat] = [];
                return;
            }
            // Map sheet rows to frontend item shape
            const rows = j.rows.map(r => {
                const item = {};
                // normalize common fields
                item.timestamp = r.timestamp || r.Timestamp || '';
                item.inventoryId = r.inventoryId || r.inventory || '';
                item.category = r.category || r.Category || cat;
                item.nombre = r.name || r.nombre || '';
                item.codigo = r.sku || r.codigo || '';
                item.cantidad = (r.quantity !== undefined && r.quantity !== null) ? r.quantity : (r.cantidad !== undefined ? r.cantidad : 0);
                item.notes = r.notes || r.Notes || '';
                item.imageUrl = r.imageUrl || r.image || '';
                // ensure id exists (use sku or timestamp)
                item.id = item.codigo || item.timestamp || makeId();
                return item;
            });
            inventory[cat] = rows;
        }catch(err){ console.error('loadInventoryForCategory failed',cat,err); inventory[cat]=[]; }
    }

    // Update quantity on Sheets by sku (uses action=update)
    async function updateQuantityRemote(cat, item, newQty){
        try{
            const invId = CATEGORY_TO_INVENTORY[cat];
            if(!invId) throw new Error('Inventory id not mapped for '+cat);
            const payload = { action: 'update', inventory: invId, sku: item.codigo || item.sku || item.codigo, quantity: String(newQty) };
            const res = await fetch(GAS_URL, { method: 'POST', headers: {'Content-Type':'application/json;charset=UTF-8'}, body: JSON.stringify(payload) });
            const txt = await res.text();
            let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch(e){ console.warn('Invalid JSON from GAS update',txt); }
            if(j && j.ok) return true; else throw new Error(j && j.error ? j.error : ('HTTP '+res.status));
        }catch(err){ console.error('updateQuantityRemote failed',err); throw err; }
    }

    // helper: all categories list
    const allCategories = Object.keys(templates);

    // Populate filterField options based on selected category (or all)
    const filterField = document.getElementById('filterField');
    function populateFilterOptions(selectedCat){
        const opts = new Set();
        opts.add('Todos');
        opts.add('categoria');
        if(!selectedCat || selectedCat==='todas'){
            allCategories.forEach(cat=> templates[cat].forEach(f=>opts.add(f)));
        }else if(templates[selectedCat]){
            templates[selectedCat].forEach(f=>opts.add(f));
        }
        // clear and append
        filterField.innerHTML = '';
        Array.from(opts).forEach(o=>{
            const op = document.createElement('option'); op.value = o; op.innerText = o=== 'Todos' ? 'Todos (buscar en todos los campos)' : o;
            filterField.appendChild(op);
        });
    }

    // --- Minimal app state helpers (define commonly used globals) ---
    const activo = localStorage.getItem('activo') || null;
    let usuarios = JSON.parse(localStorage.getItem('usuarios_v1') || '{}');
    let log = JSON.parse(localStorage.getItem('log_v1') || '[]');

    function saveInventory(){
        try{
            // Avoid storing image data (base64 or data URLs) in localStorage to prevent quota exceed.
            const safeCopy = {};
            Object.keys(inventory).forEach(cat => {
                safeCopy[cat] = (inventory[cat] || []).map(it => {
                    if(!it || typeof it !== 'object') return it;
                    const c = Object.assign({}, it);
                    delete c.imageData;
                    delete c.imageBase64;
                    return c;
                });
            });
            localStorage.setItem('inventory_v1', JSON.stringify(safeCopy));
        }catch(e){ console.warn('saveInventory failed',e); }
    }
    function saveUsers(){ try{ localStorage.setItem('usuarios_v1', JSON.stringify(usuarios)); }catch(e){ console.warn('saveUsers failed',e); } }
    function saveLog(){ try{ localStorage.setItem('log_v1', JSON.stringify(log)); }catch(e){ console.warn('saveLog failed',e); } }

    function makeId(){ return 'id_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }

    // --- Advanced search UI ---
    function openAdvancedSearch(){
        searchSteps.innerHTML = '';
        searchMenu.classList.remove('hidden');
        // Step 1: choose category (or 'todas' -> then choose specific)
        const step1 = document.createElement('div'); step1.style.marginBottom='8px';
        const lbl1 = document.createElement('label'); lbl1.innerText='Paso 1: Seleccione categor√≠a:'; step1.appendChild(lbl1);
        const sel1 = document.createElement('select'); sel1.style.width='100%';
        sel1.dataset.catchooser = '1'; // <-- marcado para identificar el selector principal
        const opAll = document.createElement('option'); opAll.value='todas'; opAll.innerText='Todas'; sel1.appendChild(opAll);
        allCategories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.innerText=c; sel1.appendChild(o); });
        sel1.value = categoriaSel.value || 'todas';
        step1.appendChild(sel1); searchSteps.appendChild(step1);

        // placeholder for step 2 (fields)
        const step2 = document.createElement('div'); step2.id='searchStepFields'; searchSteps.appendChild(step2);

        function handleCatChange(){
            const cat = sel1.value;
            buildFieldSelectors(cat);
        }
        sel1.addEventListener('change', handleCatChange);
        // initial build
        buildFieldSelectors(sel1.value);
    }

    function buildFieldSelectors(cat){
        const container = document.getElementById('searchStepFields'); container.innerHTML='';
        if(cat==='todas'){
            // ask user to pick one category to filter fields
            const p = document.createElement('div'); const lbl = document.createElement('label'); lbl.innerText='Seleccione una categor√≠a para definir los campos:'; p.appendChild(lbl);
            const sel = document.createElement('select'); sel.style.width='100%';
            sel.dataset.catchooser = '1'; // <-- marcado para identificar este selector tambi√©n
            allCategories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.innerText=c; sel.appendChild(o); });
            p.appendChild(sel); container.appendChild(p);
            sel.addEventListener('change', ()=> buildFieldSelectors(sel.value));
            return;
        }
        // Step: for each field in templates[cat], create dropdown of unique values + 'Cualquiera' + 'Personalizado'
        const fields = templates[cat] || [];
        fields.forEach(fieldName=>{
            const row = document.createElement('div'); row.style.marginBottom='6px';
            const lbl = document.createElement('label'); lbl.innerText = `Campo: ${fieldName}`; row.appendChild(lbl);
            const sel = document.createElement('select'); sel.style.width='100%'; sel.dataset.field = fieldName;
            const any = document.createElement('option'); any.value='__ANY__'; any.innerText='Cualquiera'; sel.appendChild(any);
            const custom = document.createElement('option'); custom.value='__CUSTOM__'; custom.innerText='Personalizado...'; sel.appendChild(custom);
            // collect unique values from inventory
            const values = new Set(); (inventory[cat]||[]).forEach(it=>{ const v = it[fieldName]; if(v!==undefined && v!==null && v!=='' ) values.add(v.toString()); });
            Array.from(values).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.innerText=v; sel.appendChild(o); });
            row.appendChild(sel);
            // custom input (hidden)
            const inp = document.createElement('input'); inp.style.display='none'; inp.placeholder='Valor personalizado'; inp.style.width='100%'; inp.dataset.field = fieldName;
            sel.addEventListener('change', ()=>{ if(sel.value==='__CUSTOM__') inp.style.display='block'; else inp.style.display='none'; });
            row.appendChild(inp);
            container.appendChild(row);
        });
    }

    function applyAdvancedSearch(){
        // read chosen category selector (use marker to avoid ambiguity)
        const selCat = searchSteps.querySelector('select[data-catchooser]') || searchSteps.querySelector('select');
        if(!selCat) return;
        let chosenCat = selCat.value;
        const stepFields = document.getElementById('searchStepFields');
        // if chosenCat is 'todas' and there's an inner category selector marked, use it
        if(chosenCat==='todas'){
            const innerCat = stepFields.querySelector('select[data-catchooser]');
            if(innerCat) chosenCat = innerCat.value;
        }
        // gather criteria
        const criteria = { category: chosenCat, conditions: {} };
        const selects = stepFields.querySelectorAll('select');
        selects.forEach(s=>{
            const f = s.dataset.field;
            if(!f) return; // skip category chooser
            if(s.value && s.value!=='__ANY__'){
                if(s.value==='__CUSTOM__'){
                    const inp = stepFields.querySelector(`input[data-field="${f}"]`);
                    if(inp && inp.value.trim()!=='') criteria.conditions[f]=inp.value.trim();
                } else {
                    criteria.conditions[f]=s.value;
                }
            }
        });
        // hide modal
        searchMenu.classList.add('hidden');
        // render results using criteria
        renderTableWithCriteria(criteria);
    }

    function cancelSearch(){ searchMenu.classList.add('hidden'); }

    // Render using advanced criteria object {category, conditions}
    function renderTableWithCriteria(criteria){
        if(!criteria || !criteria.category) return;
        const cat = criteria.category;
        tablesArea.innerHTML='';
        const renderCategory = (c)=>{
            if(!templates[c]) return;
            const cont = document.createElement('div'); cont.className='container';
            const h = document.createElement('h3'); h.innerText = c.toUpperCase(); cont.appendChild(h);
            const tbl = document.createElement('table');
            const thead = document.createElement('thead'); const hr = document.createElement('tr');
            templates[c].forEach(col=>{ const th=document.createElement('th'); th.innerText=col.toUpperCase(); hr.appendChild(th); });
            const tha = document.createElement('th'); tha.innerText='ACCIONES'; hr.appendChild(tha); thead.appendChild(hr); tbl.appendChild(thead);
            const tbody = document.createElement('tbody');
            (inventory[c]||[]).forEach(item=>{
                try{
                    let ok=true;
                    for(const f in criteria.conditions){
                        const want = criteria.conditions[f].toString().toLowerCase();
                        const have = (item[f]||'').toString().toLowerCase();
                        if(!have.includes(want)){ ok=false; break; }
                    }
                    if(!ok) return;
                    const tr = document.createElement('tr');
                    templates[c].forEach(key=>{
                        const td = document.createElement('td');
                        if(key==='image'){
                            if(item.imageData){ const img=document.createElement('img'); img.src=item.imageData; img.style.height='40px'; td.appendChild(img); }
                            else if(item.imageName) td.innerText = item.imageName; else td.innerText = '-';
                        } else td.innerText = item[key] || '';
                        tr.appendChild(td);
                    });
                    const tdA = document.createElement('td'); tdA.className='actions';
                    const inBtn = document.createElement('button'); inBtn.innerText='Entrada'; inBtn.addEventListener('click', async ()=>{ try{ const q=parseInt(prompt('Cantidad a agregar')||0); if(!q) return; const newQty = (parseInt(item.cantidad)||0) + q; await updateQuantityRemote(cat, item, newQty); item.cantidad = newQty; renderTableWithCriteria(criteria); }catch(e){ console.error('Entrada error',e); alert('Error en entrada (ver consola) - '+(e.message||e)); } });
                    const outBtn = document.createElement('button'); outBtn.innerText='Salida'; outBtn.addEventListener('click', async ()=>{ try{ const q=parseInt(prompt('Cantidad a retirar')||0); if(!q) return; if((item.cantidad||0) < q) return alert('Stock insuficiente'); const newQty = (parseInt(item.cantidad)||0) - q; await updateQuantityRemote(cat, item, newQty); item.cantidad = newQty; renderTableWithCriteria(criteria); }catch(e){ console.error('Salida error',e); alert('Error en salida (ver consola) - '+(e.message||e)); } });
                    const delBtn = document.createElement('button'); delBtn.innerText='Eliminar'; delBtn.addEventListener('click', ()=>{ try{ if(!confirm('Eliminar producto?')) return; inventory[c]=inventory[c].filter(x=>x.id!==item.id); saveInventory(); renderTableWithCriteria(criteria); }catch(e){ console.error('Eliminar error',e); alert('Error al eliminar (ver consola)'); } });
                    tdA.appendChild(inBtn); tdA.appendChild(outBtn); tdA.appendChild(delBtn); tr.appendChild(tdA);
                    tbody.appendChild(tr);
                }catch(err){ console.error('Error renderTableWithCriteria item',item,err); }
            });
            if(tbody.childElementCount === 0){
                const emptyTr = document.createElement('tr');
                const emptyTd = document.createElement('td');
                emptyTd.colSpan = templates[c].length + 1;
                emptyTd.style.textAlign = 'center';
                emptyTd.style.color = '#666';
                emptyTd.style.padding = '12px';
                emptyTd.innerText = 'Sin productos en esta categor√≠a';
                emptyTr.appendChild(emptyTd);
                tbody.appendChild(emptyTr);
            }
            tbl.appendChild(tbody); cont.appendChild(tbl); tablesArea.appendChild(cont);
        };
        renderCategory(cat);
    }

    // --- Form (appears only on Add) ---
    function renderForm(cat){
        console.log('renderForm start',cat);
        cat = cat || (categoriaSel? categoriaSel.value : null);
        if(!cat){ console.error('renderForm: categor√≠a no definida'); return; }
        if(!templates[cat]){ console.error('renderForm: plantilla no encontrada para',cat); alert('Categor√≠a inv√°lida'); return; }
        formArea.innerHTML = '';
        formArea.classList.remove('hidden');
        const fields = templates[cat];
        const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.gap='8px'; wrapper.style.flexWrap='wrap';
        const inputs = {};
        fields.forEach(k=>{
            const col = document.createElement('div'); col.style.display='flex'; col.style.flexDirection='column'; col.style.minWidth='140px';
            const label = document.createElement('label'); label.innerText = k.toUpperCase();
            col.appendChild(label);
            // For images keep file input
            if(k==='image'){
                const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; col.appendChild(inp); inputs[k]=inp;
            } else if(k==='cantidad'){
                const inp = document.createElement('input'); inp.type='number'; inp.min='0'; inp.value='0'; col.appendChild(inp); inputs[k]=inp;
            } else {
                // create select populated with unique existing values for this field in this category
                const sel = document.createElement('select'); sel.style.width='100%';
                const any = document.createElement('option'); any.value='__ANY__'; any.innerText='-- seleccionar sugerencia --'; sel.appendChild(any);
                const other = document.createElement('option'); other.value='__OTHER__'; other.innerText='Personalizado...'; sel.appendChild(other);
                // collect unique values
                const vals = new Set(); (inventory[cat]||[]).forEach(it=>{ const v = it[k]; if(v!==undefined && v!==null && v!=='') vals.add(v.toString()); });
                Array.from(vals).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.innerText=v; sel.appendChild(o); });
                const txt = document.createElement('input'); txt.type='text'; txt.placeholder='Valor personalizado'; txt.style.display='none'; txt.style.marginTop='6px';
                sel.addEventListener('change', ()=>{ if(sel.value==='__OTHER__') txt.style.display='block'; else txt.style.display='none'; });
                col.appendChild(sel); col.appendChild(txt); inputs[k]={ select: sel, other: txt };
            }
            // append column wrapper for every field
            wrapper.appendChild(col);
        });
        const btns = document.createElement('div'); btns.style.width='100%'; btns.style.marginTop='8px';
        const save = document.createElement('button'); save.innerText='Guardar'; save.onclick = async ()=>{
            try{
                const data = {id: makeId()};
                let pendingFile = false;

                async function finalize(){
                    // ensure category array exists
                    inventory[cat] = inventory[cat] || [];
                    const arr = inventory[cat];
                    let dup = -1;
                    arr.forEach((it,i)=>{
                        if(cat==='vidrio'){
                            if(it.tipo===data.tipo && it.color===data.color && it.grosor===data.grosor && it.forma===data.forma && it.medida1===data.medida1 && it.medida2===data.medida2) dup=i;
                        }else if(cat==='aluminio'){
                            if(it.linea===data.linea && it.serie===data.serie && it.nombre===data.nombre && it.codigo===data.codigo) dup=i;
                        }else if(cat==='herrajes'){
                            if(it.nombre===data.nombre && it.codigo===data.codigo) dup=i;
                        }else if(cat==='insumos'){
                            if(it.nombre===data.nombre && it.tipo===data.tipo && it.codigo===data.codigo) dup=i;
                        }
                    });

                    // Send to Apps Script as URL-encoded form (image as base64 field). On error, save locally.
                    try{
                        const invId = CATEGORY_TO_INVENTORY[cat] || '1';
                        const payloadObj = {
                            inventory: invId,
                            category: cat,
                            name: data.nombre || data.linea || data.nombre || '',
                            sku: data.codigo || data.serie || '',
                            quantity: data.cantidad || 0,
                            notes: JSON.stringify(data),
                            imageBase64: data.imageBase64 || '',
                            imageName: data.imageName || '',
                            imageMime: data.imageMime || 'image/png'
                        };
                        const bodyStr = new URLSearchParams(payloadObj).toString();
                        console.log('Sending urlencoded payload to GAS:', GAS_URL, payloadObj);
                        const res = await fetch(GAS_URL, { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: bodyStr });
                        console.log('GAS response status:', res.status, res.statusText);
                        const txt = await res.text();
                        console.log('GAS response body:', txt);
                        let j = {};
                        try{ j = txt ? JSON.parse(txt) : {}; }catch(err){ console.warn('Invalid JSON from GAS', err, txt); }
                        if(j && j.ok){
                            if(dup>=0){ arr[dup].cantidad = (parseInt(arr[dup].cantidad)||0) + (parseInt(data.cantidad)||0); alert('Duplicado: cantidad sumada.'); }
                            else { arr.push(data); alert('Producto agregado.'); }
                            saveInventory(); renderTable(cat, busqueda.value);
                        } else {
                            const msg = (j && j.error) ? j.error : (txt || ('HTTP ' + res.status));
                            console.warn('GAS returned error:', msg);
                            alert('Error al guardar en servidor remoto: ' + msg + '\nVer consola para m√°s detalles.');
                            throw new Error(msg);
                        }
                    }catch(e){
                        console.warn('Enviar item al servidor fall√≥, guardando localmente',e);
                        if(dup>=0){ arr[dup].cantidad = (parseInt(arr[dup].cantidad)||0) + (parseInt(data.cantidad)||0); alert('Duplicado: cantidad sumada (local).'); }
                        else { arr.push(data); alert('Producto agregado (local).'); }
                        saveInventory(); renderTable(cat, busqueda.value);
                    }

                    formArea.classList.add('hidden');
                }

                // collect fields and handle image conversion
                function fileToDataURL(file){
                    return new Promise((resolve, reject)=>{
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(e);
                        reader.readAsDataURL(file);
                    });
                }

                for(const k of fields){
                    if(k==='image'){
                        const f = inputs[k] && inputs[k].files && inputs[k].files[0];
                        if(f){
                            pendingFile = true;
                            try{
                                const dataUrl = await fileToDataURL(f);
                                data.imageData = dataUrl; // data URL for immediate preview/local storage
                                const base64 = dataUrl.split(',')[1] || '';
                                data.imageBase64 = base64;
                                data.imageName = f.name;
                                data.imageMime = f.type || 'image/png';
                            }catch(err){ console.warn('File read failed',err); }
                            pendingFile = false;
                        }
                    } else if(k==='cantidad'){
                        const el = inputs[k]; data[k] = parseInt((el && el.value) || 0) || 0;
                    } else {
                        const obj = inputs[k];
                        let val = '';
                        if(obj){
                            if(obj.select){ const selv = obj.select.value; if(selv==='__OTHER__') val = (obj.other.value||''); else if(selv==='__ANY__') val = ''; else val = selv; }
                            else if(obj.value!==undefined) val = obj.value || '';
                        }
                        data[k] = val;
                    }
                }

                if(!pendingFile) await finalize();
            }catch(err){ console.error('Error en guardar nuevo producto',err); alert('Error al guardar (ver consola)'); }
        };
        const cancel = document.createElement('button'); cancel.innerText='Cancelar'; cancel.onclick=()=>{ formArea.classList.add('hidden'); };
        btns.appendChild(save); btns.appendChild(cancel); wrapper.appendChild(btns); formArea.appendChild(wrapper);
    }

    // --- Table rendering ---
    function renderTable(cat, filter=''){
        try {
            console.log('renderTable start',cat,filter);
            const field = filterField? filterField.value : 'Todos';
            const q = (filter||'').toString().trim().toLowerCase();
            tablesArea.innerHTML = '';
            const renderCategory = (c)=>{
                if(!templates[c]) return;
                const cont = document.createElement('div'); cont.className='container';
                const h = document.createElement('h3'); h.innerText = c.toUpperCase(); cont.appendChild(h);
                const tbl = document.createElement('table');
                const thead = document.createElement('thead'); const hr = document.createElement('tr');
                templates[c].forEach(col=>{ const th=document.createElement('th'); th.innerText=col.toUpperCase(); hr.appendChild(th); });
                const tha = document.createElement('th'); tha.innerText='ACCIONES'; hr.appendChild(tha); thead.appendChild(hr); tbl.appendChild(thead);
                const tbody = document.createElement('tbody');
                (inventory[c]||[]).forEach(item=>{
                    try{
                        // match depending on selected field
                        let match = true;
                        if(q){
                            if(field==='Todos'){
                                const text = (Object.values(item).join(' ') + ' ' + c).toLowerCase(); match = text.includes(q);
                            } else if(field==='categoria'){
                                match = c.toLowerCase().includes(q);
                            } else {
                                const val = (item[field] || '').toString().toLowerCase(); match = val.includes(q);
                            }
                        }
                        if(!match) return;
                        const tr = document.createElement('tr');
                        templates[c].forEach(key=>{
                            const td = document.createElement('td');
                            if(key==='image'){
                                if(item.imageData){ const img=document.createElement('img'); img.src=item.imageData; img.style.height='40px'; td.appendChild(img); }
                                else if(item.imageName) td.innerText = item.imageName; else td.innerText = '-';
                            } else td.innerText = item[key] || '';
                            tr.appendChild(td);
                        });
                        const tdA = document.createElement('td'); tdA.className='actions';
                        const inBtn = document.createElement('button'); inBtn.innerText='Entrada';
                        inBtn.addEventListener('click', async ()=>{ try{ const q=parseInt(prompt('Cantidad a agregar')||0); if(!q) return; const newQty = (parseInt(item.cantidad)||0) + q; await updateQuantityRemote(c, item, newQty); item.cantidad = newQty; renderTable(c,filter); }catch(e){ console.error('Entrada error',e); alert('Error en entrada (ver consola) - '+(e.message||e)); } });
                        const outBtn = document.createElement('button'); outBtn.innerText='Salida';
                        outBtn.addEventListener('click', async ()=>{ try{ const q=parseInt(prompt('Cantidad a retirar')||0); if(!q) return; if((item.cantidad||0) < q) return alert('Stock insuficiente'); const newQty = (parseInt(item.cantidad)||0) - q; await updateQuantityRemote(c, item, newQty); item.cantidad = newQty; renderTable(c,filter); }catch(e){ console.error('Salida error',e); alert('Error en salida (ver consola) - '+(e.message||e)); } });
                        const delBtn = document.createElement('button'); delBtn.innerText='Eliminar';
                        delBtn.addEventListener('click', ()=>{ try{ if(!confirm('Eliminar producto?')) return; inventory[c]=inventory[c].filter(x=>x.id!==item.id); saveInventory(); renderTable(cat,filter); }catch(e){ console.error('Eliminar error',e); alert('Error al eliminar (ver consola)'); } });
                        tdA.appendChild(inBtn); tdA.appendChild(outBtn); tdA.appendChild(delBtn); tr.appendChild(tdA);
                        tbody.appendChild(tr);
                    }catch(err){ console.error('Error renderTable item',item,err); }
                });
                if(tbody.childElementCount === 0){
                    const emptyTr = document.createElement('tr');
                    const emptyTd = document.createElement('td');
                    emptyTd.colSpan = templates[c].length + 1;
                    emptyTd.style.textAlign = 'center';
                    emptyTd.style.color = '#666';
                    emptyTd.style.padding = '12px';
                    emptyTd.innerText = 'Sin productos en esta categor√≠a';
                    emptyTr.appendChild(emptyTd);
                    tbody.appendChild(emptyTr);
                }
                tbl.appendChild(tbody); cont.appendChild(tbl); tablesArea.appendChild(cont);
            };

            if(!cat || cat==='todas'){
                allCategories.forEach(c=> renderCategory(c));
            } else {
                if(!templates[cat]){ console.warn('renderTable: categor√≠a inv√°lida, mostrando todas'); allCategories.forEach(c=> renderCategory(c)); return; }
                renderCategory(cat);
            }
        } catch(err) {
            console.error('renderTable fallo', err);
            tablesArea.innerHTML = '<div style="padding:12px;background:#fff3f3;border-radius:6px;color:#900">Error al renderizar tablas. Revisa la consola (F12).</div>';
        }
    }

    // --- Admin functions ---
    function actualizarUsuariosAdmin(){
        const tbody = document.querySelector('#tablaUsuariosAdmin tbody'); tbody.innerHTML='';
        for(const u in usuarios){ if(u==='admin') continue; const tr = document.createElement('tr'); const td1=document.createElement('td'); td1.innerText=u; const td2=document.createElement('td'); td2.innerText = usuarios[u].autorizado? 'Autorizado':'Pendiente'; const td3=document.createElement('td'); const b1=document.createElement('button'); b1.innerText='‚úî'; b1.onclick=()=>{ usuarios[u].autorizado=true; log.push({fecha:new Date().toLocaleString(),usuario:'admin',accion:'Autoriz√≥ '+u}); saveUsers(); saveLog(); actualizarUsuariosAdmin(); actualizarLogAdmin(); }; const b2=document.createElement('button'); b2.innerText='‚úñ'; b2.onclick=()=>{ usuarios[u].autorizado=false; log.push({fecha:new Date().toLocaleString(),usuario:'admin',accion:'Bloque√≥ '+u}); saveUsers(); saveLog(); actualizarUsuariosAdmin(); actualizarLogAdmin(); }; td3.appendChild(b1); td3.appendChild(b2); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tbody.appendChild(tr); }
    }
    function actualizarLogAdmin(){ const tbody = document.querySelector('#tablaLogAdmin tbody'); tbody.innerHTML=''; log.forEach(l=>{ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.innerText=l.fecha; const td2=document.createElement('td'); td2.innerText=l.usuario; const td3=document.createElement('td'); td3.innerText=l.accion; tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tbody.appendChild(tr); }); }

    try{
        const exportLogBtn = document.getElementById('exportLogCSV');
        if(exportLogBtn) exportLogBtn.addEventListener('click', ()=>{ let csv='Fecha,Usuario,Accion\n'; log.forEach(l=> csv += `${l.fecha},${l.usuario},${l.accion}\n`); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='bitacora_bodega.csv'; a.click(); });
        else console.warn('exportLogCSV button missing');

        if(!categoriaSel) console.error('categoriaSel missing');
        categoriaSel.addEventListener('change', async ()=>{ try{ console.log('categoria changed to',categoriaSel.value); formArea.classList.add('hidden'); if(categoriaSel.value === 'todas'){ await Promise.all(allCategories.map(loadInventoryForCategory)); } else { await loadInventoryForCategory(categoriaSel.value); } populateFilterOptions(categoriaSel.value); renderTable(categoriaSel.value, busqueda.value); }catch(e){ console.error('categoria change handler failed',e); } });
        busqueda.addEventListener('input', ()=>{ console.log('busqueda', busqueda.value); renderTable(categoriaSel.value, busqueda.value); });
        filterField.addEventListener('change', ()=>{ console.log('filterField', filterField.value); renderTable(categoriaSel.value, busqueda.value); });
        btnAdvancedSearch.addEventListener('click', ()=>{ openAdvancedSearch(); });
        applySearchBtn.addEventListener('click', ()=>{ applyAdvancedSearch(); });
        cancelSearchBtn.addEventListener('click', ()=>{ cancelSearch(); });
        btnNew.addEventListener('click', ()=>{ console.log('btnNew clicked for',categoriaSel.value); const catSel = categoriaSel.value; if(!catSel || catSel==='todas'){ alert('Seleccione una categor√≠a espec√≠fica antes de agregar un producto.'); return; } renderForm(catSel); });
        btnLogout.addEventListener('click', ()=>{ try{ localStorage.removeItem('activo'); location.href='index.html'; }catch(e){ console.error('logout error',e); } });
    }catch(err){ console.error('Error wiring events',err); }

    // --- Init ---
    if(!activo){ alert('No est√°s autenticado'); location.href='index.html'; }
    usuarioActivoEl.innerText = activo;
    if(activo==='admin'){ adminPanel.classList.remove('hidden'); actualizarUsuariosAdmin(); actualizarLogAdmin(); }
    // populate filter options and initial render (protegido)
    try{
        populateFilterOptions(categoriaSel.value);
        // attempt to sync categories with Apps Script (best-effort)
        try{ syncCategoriesToGAS(); }catch(e){}
        // load inventory data from Sheets then render (wrapped in async IIFE)
        try{
            (async ()=>{
                if(categoriaSel.value === 'todas'){
                    await Promise.all(allCategories.map(loadInventoryForCategory));
                } else {
                    await loadInventoryForCategory(categoriaSel.value);
                }
                renderTable(categoriaSel.value);
            })().catch(err=>{ console.error('Error loading inventory on init',err); renderTable(categoriaSel.value); });
        }catch(err){ console.error('Inicializaci√≥n (sync) fall√≥',err); }
    }catch(e){
        console.error('Inicializaci√≥n fall√≥',e);
        // fallback: force 'todas' and render minimal UI
        try{ categoriaSel.value='todas'; populateFilterOptions('todas'); renderTable('todas'); }catch(e2){ tablesArea.innerHTML = '<div style="padding:12px;background:#fff3f3;border-radius:6px;color:#900">No se pudieron mostrar las tablas. Ver consola.</div>'; }
    }

    </script>

</body>
</html>
